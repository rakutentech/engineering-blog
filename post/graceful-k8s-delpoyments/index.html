<html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=icon href=/images/favicon.svg><link rel=stylesheet href=/scss/main.min.b3ed7c7076a200b40314c0134930ccd8fa88a21a0b3fcdcf5c1bd1ae2ff9de60.css><link rel=stylesheet href=/css/prism.css><link href="https://fonts.googleapis.com/css?family=Merriweather&display=swap" rel=stylesheet><title>Zero-Downtime Rolling Deployments in Kubernetes | Rakuten Engineering Blog</title><meta name=description content="Photo by Kammeran Gonzalez-Keola used under Pexels License
At Rakuten, we generally use Kubernetes to run our services. Kubernetes enables us to operate robust systems at scale. However, Kubernetes is not perfect and in edge cases it may behave in unexpected ways. For example, during rolling deployments we expect no request failures &mdash; a reasonable expectation, right? But when we ran functional tests during a deployment we noticed some requests failing &mdash; to our surprise."><meta property="og:title" content="Zero-Downtime Rolling Deployments in Kubernetes | Rakuten Engineering Blog"><meta property="og:site_name" content="Rakuten Engineering Blog"><meta property="og:description" content="Photo by Kammeran Gonzalez-Keola used under Pexels License
At Rakuten, we generally use Kubernetes to run our services. Kubernetes enables us to operate robust systems at scale. However, Kubernetes is not perfect and in edge cases it may behave in unexpected ways. For example, during rolling deployments we expect no request failures &mdash; a reasonable expectation, right? But when we ran functional tests during a deployment we noticed some requests failing &mdash; to our surprise."><meta property="og:url" content="https://engineering.rakuten.today/post/graceful-k8s-delpoyments/"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://engineering.rakuten.today/images/rolling-waves.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Zero-Downtime Rolling Deployments in Kubernetes | Rakuten Engineering Blog"><link rel=canonical href=https://engineering.rakuten.today/post/graceful-k8s-delpoyments/><meta name=twitter:description content="Photo by Kammeran Gonzalez-Keola used under Pexels License
At Rakuten, we generally use Kubernetes to run our services. Kubernetes enables us to operate robust systems at scale. However, Kubernetes is not perfect and in edge cases it may behave in unexpected ways. For example, during rolling deployments we expect no request failures &mdash; a reasonable expectation, right? But when we ran functional tests during a deployment we noticed some requests failing &mdash; to our surprise."><meta name=twitter:image content="https://engineering.rakuten.today/images/rolling-waves.jpg"><meta property="article:published_time" content="2021-07-18T00:00:00+00:00"><meta property="article:updated_time" content="2021-07-18T00:00:00+00:00"><script type=application/javascript>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,GA_SESSION_STORAGE_KEY,doNotTrack=dnt=="1"||dnt=="yes";doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,window.sessionStorage&&(GA_SESSION_STORAGE_KEY="ga:clientId",ga("create","G-Z6FNGN7J13",{storage:"none",clientId:sessionStorage.getItem(GA_SESSION_STORAGE_KEY)}),ga(function(e){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,e.get("clientId"))})),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=line-numbers><script src=/js/initColors.js></script><div class=layout-styled><section class=section><div class=nav-container><a class=logo-link href=/><div id=logo-desktop><svg height="32" viewBox="0 0 333.4 41.1" xmlns="http://www.w3.org/2000/svg"><path class="change-fill" d="M111.3 34.5H27.6l6.7 6.6zM35.4 7.5v1c-1.6-1-2.9-1.6-4.9-1.6-5.9.0-10.3 5.3-10.3 11.9.0 6.6 4.5 11.9 10.3 11.9 1.9.0 3.3-.6 4.9-1.6v1h5.2V7.5h-5.2zm-4.9 17.8c-2.9.0-5-2.8-5-6.4.0-3.6 2.1-6.4 5-6.4s4.9 2.8 4.9 6.4c.1 3.6-2 6.4-4.9 6.4zM76.6 7.5v13.3c0 2.5-1.7 4.6-4.2 4.6s-4.2-2.1-4.2-4.6V7.5h-5.1v13.3c0 5.5 3.7 9.9 9.2 9.9 2.5.0 4.4-1.4 4.4-1.4v.8h5.2V7.5h-5.3zm48 22.7V16.9c0-2.5 1.7-4.6 4.2-4.6s4.2 2.1 4.2 4.6v13.3h5.1V16.9c0-5.5-3.7-9.9-9.2-9.9-2.5.0-4.4 1.4-4.4 1.4v-.9h-5.1v22.7h5.2z"/><path class="change-fill" d="M5.4 30.2v-8.8h3.8l6.6 8.8h6.7l-8-10.6c2.5-1.8 4.1-4.7 4.1-8 0-5.4-4.4-9.8-9.8-9.8H0v28.3h5.4zm0-22.9h3.5c2.4.0 4.4 2 4.4 4.4s-2 4.4-4.4 4.4H5.4V7.3zM95.7 24.9c-.5.3-1 .6-1.7.6-.8.0-2.4-.6-2.4-2.8V13H96V7.5h-4.4V1.9h-5.1v5.7h-2.7V13h2.7v9.8c0 5.1 3.8 8.1 7.7 8.1 1.4.0 3.4-.5 5-1.4l-3.5-4.6zM53.3 18.2l8.9-10.7H55l-6.2 7.9V0h-5.3v30.2h5.3v-9.3l7.6 9.3h7.2z"/><path class="change-fill" d="M107.6 7c-6 0-10.2 5.2-10.2 11.9.0 7 5.4 11.9 10.7 11.9 2.7.0 6.2-.9 9.1-5.1l-4.5-2.6c-3.5 5.2-9.4 2.6-10.1-2.6h14.8c1.3-8.2-4-13.5-9.8-13.5zm4.5 8.9h-9.3c1.1-5.3 8.3-5.6 9.3.0z"/><path class="change-fill" d="M155.5 3.3c7 0 12.1 5.6 12.1 13.4.0 8-5 13.5-12.1 13.5h-8.8V3.3h8.8zm-3.6 22.1h3.7c4 0 6.7-3.5 6.7-8.7.0-5.1-2.7-8.7-6.7-8.7h-3.7v17.4zM188.6 25.9c-2.4 3.3-5.2 4.8-8.8 4.8-6.2.0-10.6-4.7-10.6-11.3.0-6.4 4.3-11.4 10-11.4 5.5.0 10 5 10 11.3.0.5.0 1-.1 1.6H175c.3 3 2.3 4.9 5.1 4.9 1.5.0 2.9-.9 4.2-2.5l4.3 2.6zm-5.3-9.3c-.5-2.6-1.9-3.9-4.1-3.9-2.1.0-3.7 1.4-4.2 3.9h8.3zm18.2 13.6h-5.7l-7.2-21.6h5.9l4.2 14.4 4.2-14.4h5.9l-7.3 21.6zm26.1-4.3c-2.4 3.3-5.2 4.8-8.8 4.8-6.2.0-10.6-4.7-10.6-11.3.0-6.4 4.3-11.4 10-11.4 5.5.0 10 5 10 11.3.0.5.0 1-.1 1.6H214c.3 3 2.3 4.9 5.1 4.9 1.5.0 2.9-.9 4.2-2.5l4.3 2.6zm-5.3-9.3c-.5-2.6-2-3.9-4.1-3.9s-3.7 1.4-4.2 3.9h8.3zM230.2 30.2V1.5h5.5v28.7h-5.5zm28-10.8c0 6.6-4.2 11.3-10.1 11.3S238 25.9 238 19.4s4.2-11.3 10.1-11.3 10.1 4.8 10.1 11.3zm-15.1.1c0 3.5 2.1 6.2 5 6.2s5-2.6 5-6.2-2.1-6.2-5-6.2c-2.9-.1-5 2.6-5 6.2zm22.4-8.9c1.3-1.6 2.9-2.5 5-2.5 5.5.0 10.1 5.1 10.1 11.3.0 6.3-4.4 11.3-9.9 11.3-2 0-3.7-.8-5.2-2.2v7.1h-5.1v-27h4.4l.7 2zm0 8.8c0 3.8 2.1 6.5 5 6.5 2.8.0 5-2.9 5-6.5.0-3.7-2.2-6.5-5-6.5-2.9.0-5 2.8-5 6.5zm36 6.5c-2.4 3.3-5.2 4.8-8.8 4.8-6.2.0-10.6-4.7-10.6-11.3.0-6.4 4.3-11.4 10-11.4 5.5.0 10 5 10 11.3.0.5.0 1-.1 1.6h-14.1c.3 3 2.3 4.9 5.1 4.9 1.5.0 2.9-.9 4.2-2.5l4.3 2.6zm-5.2-9.3c-.5-2.6-2-3.9-4.1-3.9s-3.7 1.4-4.2 3.9h8.3zm12.4-6c1.4-1.6 3.6-2.5 6.3-2.5v4.8c-2.4.2-3.8.9-4.8 2.4-.6.9-.9 2-.9 3.1v11.8h-5.1V8.7h4.1l.4 1.9zm20.5 4.5c-1.5-1.5-2.8-2.2-4.3-2.2-1.4.0-2.4.7-2.4 1.8.0 1 .6 1.6 2.2 2 2.6.7 4.1 1.3 5.3 1.9 2.3 1.3 3.4 3.1 3.4 5.4.0 4-3.4 6.7-8.5 6.7-3.9.0-6.7-1.4-8.8-4.3l3.5-3.3c1.3 1.8 3.2 2.8 5.4 2.8 1.9.0 2.9-.7 2.9-1.9.0-1.1-.8-1.7-4-2.8-2.8-1-3.6-1.3-4.6-2-1.6-1.1-2.3-2.6-2.3-4.6.0-3.8 3.4-6.6 7.9-6.6 2.9.0 5.3 1 7.7 3.1l-3.4 4z"/></svg></div><div id=logo-mobile class=hidden><svg height="52" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 187 76"><path d="M111.3 34.5H27.6l6.7 6.6 77-6.6zm-75.9-27v1a8.4 8.4.0 00-4.9-1.6c-5.9.0-10.3 5.3-10.3 11.9.0 6.6 4.5 11.9 10.3 11.9 1.9.0 3.3-.6 4.9-1.6v1h5.2V7.5h-5.2zm-4.9 17.8c-2.9.0-5-2.8-5-6.4.0-3.6 2.1-6.4 5-6.4s4.9 2.8 4.9 6.4c.1 3.6-2 6.4-4.9 6.4zM76.6 7.5v13.3c0 2.5-1.7 4.6-4.2 4.6s-4.2-2.1-4.2-4.6V7.5h-5.1v13.3c0 5.5 3.7 9.9 9.2 9.9 2.5.0 4.4-1.4 4.4-1.4v.8h5.2V7.5h-5.3zm48 22.7V16.9c0-2.5 1.7-4.6 4.2-4.6s4.2 2.1 4.2 4.6v13.3h5.1V16.9c0-5.5-3.7-9.9-9.2-9.9-2.5.0-4.4 1.4-4.4 1.4v-.9h-5.1v22.7h5.2z" class="change-fill"/><path d="M5.4 30.2v-8.8h3.8l6.6 8.8h6.7l-8-10.6A9.8 9.8.0 008.8 1.8H0v28.3h5.4v.1zm0-22.9h3.5c2.4.0 4.4 2 4.4 4.4s-2 4.4-4.4 4.4H5.4V7.3zm90.3 17.6c-.5.3-1 .6-1.7.6-.8.0-2.4-.6-2.4-2.8V13H96V7.5h-4.4V1.9h-5.1v5.7h-2.7V13h2.7v9.8c0 5.1 3.8 8.1 7.7 8.1 1.4.0 3.4-.5 5-1.4l-3.5-4.6zm-42.4-6.7 8.9-10.7H55l-6.2 7.9V0h-5.3v30.2h5.3v-9.3l7.6 9.3h7.2l-10.3-12z" class="change-fill"/><path d="M107.6 7c-6 0-10.2 5.2-10.2 11.9.0 7 5.4 11.9 10.7 11.9 2.7.0 6.2-.9 9.1-5.1l-4.5-2.6c-3.5 5.2-9.4 2.6-10.1-2.6h14.8c1.3-8.2-4-13.5-9.8-13.5zm4.5 8.9h-9.3c1.1-5.3 8.3-5.6 9.3.0zM8.8 43.5c7 0 12 5.6 12 13.4.0 8-5 13.5-12 13.5H0v-27h8.8zm-3.6 22h3.7c4 0 6.7-3.4 6.7-8.6.0-5.1-2.7-8.7-6.7-8.7H5.2v17.4zm36.7.6c-2.4 3.3-5.2 4.8-8.8 4.8-6.2.0-10.6-4.7-10.6-11.3.0-6.4 4.3-11.4 10-11.4 5.5.0 10 5 10 11.3l-.1 1.6H28.3c.3 3 2.3 4.9 5 4.9 1.6.0 3-1 4.3-2.5l4.3 2.6zm-5.3-9.3c-.5-2.6-2-4-4.1-4s-3.7 1.5-4.2 4h8.3zm18.2 13.6H49l-7.2-21.6h5.9L52 63.2l4.2-14.4H62l-7.3 21.6zm26-4.3c-2.3 3.3-5.1 4.8-8.7 4.8-6.2.0-10.6-4.7-10.6-11.3.0-6.4 4.3-11.4 10-11.4 5.5.0 10 5 10 11.3l-.1 1.6H67.3c.3 3 2.3 4.9 5 4.9 1.6.0 3-1 4.3-2.5l4.3 2.6zm-5.2-9.3c-.5-2.6-2-4-4.1-4s-3.7 1.5-4.2 4h8.3zm7.9 13.6V41.7H89v28.7h-5.5zm28-10.8c0 6.6-4.2 11.3-10.1 11.3-6 0-10.1-4.8-10.1-11.3s4.2-11.3 10-11.3c6 0 10.2 4.8 10.2 11.3zm-15.1.0c0 3.6 2 6.3 5 6.3s5-2.6 5-6.2-2.1-6.2-5-6.2c-3-.1-5 2.6-5 6.2zm22.4-8.8a6.2 6.2.0 015-2.5c5.5.0 10 5 10 11.3s-4.3 11.3-9.8 11.3c-2 0-3.7-.8-5.2-2.2v7h-5.1v-27h4.4l.7 2zm0 8.8c0 3.8 2 6.5 5 6.5 2.8.0 5-3 5-6.5.0-3.7-2.2-6.5-5-6.5-3 0-5 2.8-5 6.5zm36 6.5c-2.4 3.3-5.2 4.8-8.8 4.8-6.2.0-10.6-4.7-10.6-11.3.0-6.4 4.3-11.4 10-11.4 5.5.0 10 5 10 11.3l-.1 1.6h-14.1c.3 3 2.3 4.9 5 4.9 1.6.0 3-1 4.3-2.5l4.3 2.6zm-5.2-9.3c-.5-2.6-2-4-4.1-4s-3.7 1.5-4.2 4h8.3zm12.4-6a8.1 8.1.0 016.3-2.5V53c-2.4.2-3.8.9-4.8 2.4-.6.9-1 2-1 3v11.9h-5V48.9h4l.5 1.9zm20.5 4.5c-1.5-1.5-2.8-2.2-4.3-2.2-1.4.0-2.4.7-2.4 1.8.0 1 .6 1.6 2.2 2 2.6.7 4 1.3 5.3 1.9 2.3 1.3 3.4 3 3.4 5.4.0 4-3.4 6.7-8.5 6.7a10 10 0 01-8.8-4.3l3.5-3.3a6.5 6.5.0 005.4 2.8c1.9.0 2.9-.7 2.9-2 0-1-.8-1.6-4-2.7-2.8-1-3.6-1.3-4.6-2a5.2 5.2.0 01-2.3-4.6c0-3.8 3.4-6.6 7.9-6.6 2.9.0 5.3 1 7.7 3l-3.4 4z" class="change-fill"/></svg></div><span class=header-hidden>Navigate back to the homepage</span></a><div class=nav-controls><button id=copyButton class=icon-wrapper><svg class="icon-image" width="24" height="20" viewBox="0 0 24 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" clipRule="evenodd" d="M2 5C2 3.34328 3.34328 2 5 2h9c1.6567.0 3 1.34328 3 3V9c0 1.6567-1.3433 3-3 3H10C9.44771 12 9 12.4477 9 13S9.44771 14 10 14h4c2.7613.0 5-2.2387 5-5V5c0-2.76128-2.2387-5-5-5H5C2.23872.0.0 2.23872.0 5V9c0 1.4938.656313 2.8361 1.6935 3.7509C2.10768 13.1163 2.73961 13.0767 3.10494 12.6625 3.47028 12.2483 3.43068 11.6164 3.0165 11.2511 2.39169 10.6999 2 9.89621 2 9V5zm5 6c0-1.65672 1.34328-3 3-3h4C14.5523 8 15 7.55228 15 7S14.5523 6 14 6H10C7.23872 6 5 8.23872 5 11v4c0 2.7613 2.23872 5 5 5h9c2.7613.0 5-2.2387 5-5V11C24 9.50621 23.3437 8.16393 22.3065 7.24906 21.8923 6.88372 21.2604 6.92332 20.8951 7.3375 20.5297 7.75168 20.5693 8.38361 20.9835 8.74894 21.6083 9.30007 22 10.1038 22 11v4c0 1.6567-1.3433 3-3 3H10c-1.65672.0-3-1.3433-3-3V11z" fill="#000"/></svg><div id=toolTip class=tool-tip>copied</div><input id=copyText style=opacity:0 type=text class=tool-tip></button>
<button id=themeColorButton class=icon-wrapper><div id=sunRays class=sun-rays></div><div id=moonOrSun class=moon-or-sun></div><div id=moonMask class=moon-mask></div></button></div></div></section><script src=/js/toggleLogos.js></script>
<script src=/js/toggleColors.js></script>
<script src=/js/copyUrl.js></script><section class="section narrow"><section id=articleHero class="section narrow"><div class=article-hero><header class=article-header><h1 class=article-hero-heading>Zero-Downtime Rolling Deployments in Kubernetes</h1><div class=article-hero-subtitle><div class=article-meta><div class=article-coauthors-container><span id=collapsedCoauthors class=article-coauthors-collapsed><div class=article-coauthors-list style=width:60px><div class=article-coauthors-avatar style=left:0><img src=/authors/manish-yadav/manish-yadav.jpg></div><div class=article-coauthors-avatar style=left:15px><img src=/authors/oscar-garcia/oscar_garcia.jpeg></div><div class=article-coauthors-avatar style=left:30px><img src=/authors/nemo/nemo-avatar.jpg></div><div class=article-coauthors-avatar style=left:45px><img src=/authors/boaz-yaniv/boaz-yaniv-avatar.jpg></div></div><strong class=article-coauthors-name-container>Manish,
Oscar,
Nemo,
Boaz</strong><div class=article-coauthors-icon-container><svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path style="fill:var(--primary)" d="M5.3209 8.86719 8.50026 12.0396 11.6796 8.86719 12.6563 9.84385 8.50026 13.9999 4.34424 9.84385 5.3209 8.86719z"/><path style="fill:var(--primary)" d="M11.6791 8.13281 8.49974 4.96039 5.32039 8.13281 4.34373 7.15615 8.49974 3.00013 12.6558 7.15615 11.6791 8.13281z"/></svg></div></span><ul id=uncollapsedCoauthors class="article-coauthors-list-open hidden"><div id=uncollapsedAction class=article-icon-open-container><svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path style="fill:var(--primary)" d="M11.6796 14 8.50023 10.8276 5.32088 14 4.34422 13.0233 8.50023 8.86732 12.6563 13.0233 11.6796 14z"/><path style="fill:var(--primary)" d="M5.32041 3 8.49977 6.17243 11.6791 3 12.6558 3.97666 8.49977 8.13268 4.34375 3.97666 5.32041 3z"/></svg></div><li class=article-coauthors-list-item-open><a href=/authors/manish-yadav/ class=article-author-link><div class=article-coauthor-avatar-open><img src=/authors/manish-yadav/manish-yadav.jpg></div><strong class=article-author-name-open>Manish Yadav</strong></a></li><li class=article-coauthors-list-item-open><a href=/authors/oscar-garcia/ class=article-author-link><div class=article-coauthor-avatar-open><img src=/authors/oscar-garcia/oscar_garcia.jpeg></div><strong class=article-author-name-open>Oscar Garcia</strong></a></li><li class=article-coauthors-list-item-open><a href=/authors/nemo/ class=article-author-link><div class=article-coauthor-avatar-open><img src=/authors/nemo/nemo-avatar.jpg></div><strong class=article-author-name-open>Nemo</strong></a></li><li class=article-coauthors-list-item-open><a href=/authors/boaz-yaniv/ class=article-author-link><div class=article-coauthor-avatar-open><img src=/authors/boaz-yaniv/boaz-yaniv-avatar.jpg></div><strong class=article-author-name-open>Boaz Yaniv</strong></a></li></ul></div><script src=/js/collapseAuthors.js></script>
July 18, 2021
• 11 min read</div><div id=share-buttons><div class=linkedin title="Share this on Linkedin" onclick='window.open("https://www.linkedin.com/shareArticle?mini=true&url=https://engineering.rakuten.today/post/graceful-k8s-delpoyments/&title=&summary=&source=")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991H147V625h330zm21-306q1 73-50.5 122T312 490h-2q-82 0-132-49t-50-122q0-74 51.5-122.5T314 148t133 48.5T498 319zm1166 729v568h-329v-530q0-105-40.5-164.5T1168 862q-63 0-105.5 34.5T999 982q-11 30-11 81v553H659q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5T1285 602q171 0 275 113.5t104 332.5z"/></svg></div><div class=twitter title="Share this on Twitter" onclick='window.open("https://twitter.com/intent/tweet?text=https://engineering.rakuten.today/post/graceful-k8s-delpoyments/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div><div class=facebook title="Share this on Facebook" onclick='window.open("http://www.facebook.com/share.php?u=https://engineering.rakuten.today/post/graceful-k8s-delpoyments/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759H734V905H479V609h255V391q0-186 104-288.5T1115 0q147 0 228 12z"/></svg></div><div class=mail title="Share this through Email" onclick='window.open("mailto:?&body=https://engineering.rakuten.today/post/graceful-k8s-delpoyments/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47H160q-66 0-113-47T0 1504V710q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 1e2-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38T639 1015q-91-64-262-182.5T172 690q-62-42-117-115.5T0 438q0-78 41.5-130T160 256h1472q65 0 112.5 47t47.5 113z"/></svg></div></div></div></header><div class=article-hero-image id=ArticleImage__Hero><img src=/images/rolling-waves.jpg></div></div></section><aside id=progressBar class=aside-container><div class=aside-align><div><div class=overlap-container></div></div></div><div class=progress-container tabindex={-1}><div class=track-line aria-hidden=true><div id=progressIndicator class=progress-line></div></div></div></aside><article id=articleContent class=post-content style=position:relative><p><em><a href=https://www.pexels.com/@kammeran-gonzalez-keola-3137381 target=_blank rel="external noopener noreferrer nofollow">Photo by Kammeran Gonzalez-Keola</a> used under <a href=https://www.pexels.com/license/ target=_blank rel="external noopener noreferrer nofollow">Pexels License</a></em></p><p>At Rakuten, we generally use Kubernetes to run our services. Kubernetes enables us to operate robust systems at scale. However, Kubernetes is not perfect and in edge cases it may behave in unexpected ways. For example, during rolling deployments we expect no request failures &mdash; a reasonable expectation, right? But when we ran functional tests during a deployment we noticed some requests failing &mdash; to our surprise. After researching this for a while we learned that&mldr;</p><blockquote><p>Kubernetes will send traffic to terminating pods.</p></blockquote><p>Even after starting the pod shutdown process, which includes sending a <code>TERM</code> signal to pods, Kubernetes still sends new requests to the pod. Because there is no orchestration between Kubernetes sending <code>TERM</code> signal and removing the pod from its service endpoint list. Those 2 operations can happen in any order, possibly with delay in between them. Yikes 😬.</p><p>In this article, we explore the Kubernetes pod eviction mechanism and show different approaches to avoid these surprising errors in apps deployed with Kubernetes.</p><h2 id=kubernetes-pod-termination-process>Kubernetes Pod Termination Process</h2><p>A pod can be evicted for multiple reasons. For example, when a node is drained, via <code>kubectl delete</code>, or when the scheduler evicts pods to allow the execution of higher-priority ones. The eviction process starts when the API server modifies the state of a pod in <code>etcd</code> to the <code>Terminating</code> state. The node’s kubelet and the endpoints-controller are continuously watching the pod&rsquo;s state. Once they notice the termination state they start the eviction process:</p><ol><li>Kubelet performs the pod eviction.</li><li>The endpoints-controller handles the endpoint removal process.</li></ol><p>Both operations are asynchronous.</p><p><img src=./images/sigterm.png alt="SIGTERM in Kubernetes"></p><p>When kubelet acknowledges that a pod should be terminated, it initiates a shutdown sequence for each container in the pod. First, it runs <a href=https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#hook-handler-execution target=_blank rel="external noopener noreferrer nofollow">the container&rsquo;s pre-stop hook</a> (if it exists), then sends a <code>TERM</code> signal, and finally waits for the termination of the container. This sequential process should take less than 30 seconds (or the value in seconds specified in the <a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#podspec-v1-core target=_blank rel="external noopener noreferrer nofollow"><code>spec.terminationGracePeriodSeconds</code></a> field). If the container is still running beyond this time, kubelet waits for 2 more seconds, and then kills the container forcibly by sending a <code>KILL</code> signal.</p><p><img src=./images/sigkill.png alt="SIGKILL in Kubernetes"></p><p>In parallel, the endpoints-controller removes the pod&rsquo;s endpoint by requesting the API server. This server notifies all the kube-proxies on the worker nodes. Each kube-proxy removes the endpoint from the iptables rules in its node. Note that changes in the iptables do not affect already established connections.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>To achieve graceful shutdowns in pods, it is important to understand the asynchronous nature of the pod eviction process. We cannot make assumptions about which of the eviction processes will complete first. If the endpoint removal process finishes before the containers receive the <code>TERM</code> signal, no new requests will arrive while the containers are terminating. That&rsquo;s what we expect (or hope 😅). However, if the containers start terminating before the endpoint removal process is finished, the pods will continue to receive requests. In that case, clients will get &ldquo;Connection timeout&rdquo; or &ldquo;Connection refused&rdquo; errors as responses. Because the endpoint removal must propagate to every node in the cluster before it is complete, there is a high probability that the pod eviction process completes first. LearnK8s created a <a href=https://learnk8s.io/a/graceful-shutdown-and-zero-downtime-deployments-in-kubernetes/graceful-shutdown.pdf target=_blank rel="external noopener noreferrer nofollow">neat visual representation of these two scenarios</a>.</p><p>Now that we understand the cause of the problem let&rsquo;s look at different solutions!</p><h2 id=prerequisite-handle-sigterm-correctly>Prerequisite: Handle <code>SIGTERM</code> correctly</h2><p>First of all, we must make sure that the application terminates gracefully when the kubelet sends the <code>TERM</code> signal to the container.</p><blockquote><p>Your code should listen for this event and start shutting down cleanly at this point. This may include stopping any long-lived connections (like a database connection or WebSocket stream), saving the current state, or anything like that.</p><p><strong>&mdash; <a href=https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace target=_blank rel="external noopener noreferrer nofollow">Kubernetes best practices: terminating with grace</a></strong></p></blockquote><p>Fortunately, web application frameworks often support graceful shutdown with little or no configuration. For example, Spring Boot requires <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.graceful-shutdown target=_blank rel="external noopener noreferrer nofollow">just 2 lines of configuration</a> and Express.js apps need <a href=https://expressjs.com/en/advanced/healthcheck-graceful-shutdown.html target=_blank rel="external noopener noreferrer nofollow">3 lines of JavaScript code</a>.</p><p>Next, you should double-check that your application is actually receiving the <code>TERM</code> signal &mdash; it might not! For example, the busybox <code>sh</code> that comes with Linux Alpine does not pass signals to children. We need a more capable shell (e.g. <code>bash</code>) or an init system can handle and forward signals.</p><p>Moreover, we don&rsquo;t control how off-the-shelf software reacts to a <code>TERM</code> signal. For example, HAproxy performs a hard stop when it receives the <code>TERM</code> signal and terminates gracefully when it receives the <code>USR1</code> signal. So we need to re-map the signal we receive from Kubernetes (<code>TERM</code>) to the signal that HAproxy &ldquo;understands&rdquo; (<code>USR1</code>). In the following example, we use <code>dumb-init</code> to handle signals, convert the <code>TERM</code> (<code>15</code>) to <code>USR1</code> (<code>10</code>) by using the <code>—-rewrite</code> option and send the signal to HAproxy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span>ROM alpine:3.5<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --no-cache bash<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Install haproxy</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>apk add haproxy<span style=color:#f92672>=</span>2.0.14-r0 <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Download dumb-init</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64 /usr/local/bin/dumb-init<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /usr/local/bin/dumb-init<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Run dumb-init with the signal rewrite definitons and haproxy as child process</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/usr/local/bin/dumb-init&#34;</span>,<span style=color:#e6db74>&#34;--rewrite&#34;</span>,<span style=color:#e6db74>&#34;15:10&#34;</span>,<span style=color:#e6db74>&#34;haproxy&#34;</span>,<span style=color:#e6db74>&#34;-f&#34;</span>,<span style=color:#e6db74>&#34;config.cfg&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=idea-1-sleep-in-the-pre-stop-hook>Idea #1: Sleep in the pre-stop hook</h2><p>A common mitigation is to pause the pod eviction process in order to wait for the endpoint removal process to propagate throughout the Kubernetes cluster. After all, not only kube-proxies must be notified, but also other components such as ingress controllers and load balancers. To do that, we can use two settings in the <a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#podspec-v1-core target=_blank rel="external noopener noreferrer nofollow">pod spec</a>: <code>spec.lifecycle.preStop</code> and <code>spec.terminationGracePeriodSeconds</code>.</p><p>As described above, the pre-stop hook executes before containers receive the <code>TERM</code> signal, so we can use it to achieve a graceful shutdown.
To mitigate the problem, we add a <code>sleep</code> command in the pre-stop hook.
This will delay the <code>TERM</code> signal and create time for the endpoint removal to propagate.</p><h3 id=how-long-should-i-wait-in-the-pre-stop-hook>How long should I wait in the pre-stop hook?</h3><p>It depends on the latency of your network and the nodes. You may need to perform some tests to find out this value. However, multiple sources suggest a value between 5-10 seconds should be enough for most cases.</p><p>Next, <code>spec.terminationGracePeriodSeconds</code> is the time limit that kubelet will wait before killing the container forcibly. The termination grace period starts from the execution of the pre-stop hook. Again there is no universally correct length for the grace period, you must calculate the value for <code>spec.terminationGracePeriodSeconds</code> based on your cluster and application behavior. It should include the sleep time in the pre-stop hook and the termination time of your application.</p><p>For example a 20 second delay with up to 40 seconds of application shutdown time results in the following config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;{{APP_NAME}}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>lifecycle</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>preStop</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/sh&#34;</span>,<span style=color:#e6db74>&#34;-c&#34;</span>,<span style=color:#e6db74>&#34;sleep 20&#34;</span>]
</span></span></code></pre></div><p>An important note about long-lived TCP connections: the endpoint eviction does not affect established connections. So either you need a long enough <code>spec.terminationGracePeriodSeconds</code> to terminate long-lived connections, or you need to ensure that connections are short-lived.</p><h3 id=sleep-in-the-pre-stop-hook---trade-offs>Sleep in the pre-stop hook - Trade-Offs</h3><p>Sleeping in the pre-stop is a trick to avoid a problem that will (hopefully) be solved in the future. However, the pre-stop hook is not intended for this purpose, abusing the hook may make the deployment fail in future Kubernetes releases.</p><p>Moreover, this approach requires guesswork. If we sleep too long deployments become unnecessarily slow, if we don&rsquo;t sleep long enough we don&rsquo;t resolve the problem.</p><p>On the other hand, this requires only changes in our Kubernetes deployment yaml files, the application code stays untouched. So if this stops working in a future Kubernetes release we can update our Kubernetes config files without building new container images &mdash; so it all stays on the Kubernetes config layer.</p><p>Another positive aspect is that the configuration is spatially close, right next to each other in the config file. In other words, it has high spatial cohesion, which improves readability & maintainability.</p><h2 id=idea-2-delay-app-shutdown>Idea #2: Delay app shutdown</h2><p>Instead of sleeping in the pre-stop hook, we can wait in the application for some time until (hopefully) no more requests come in. Application frameworks and runtimes expose hooks to receive & handle process signals<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, for example in <a href=https://expressjs.com/en/advanced/healthcheck-graceful-shutdown.html target=_blank rel="external noopener noreferrer nofollow">Express.js</a> applications:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>port</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;SIGTERM&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#39;SIGTERM signal received: closing HTTP server in 10 seconds&#39;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>closeServer</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>close</span>()
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>closeServer</span>, <span style=color:#ae81ff>10_000</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>For off-the-shelf software we can wrap the application in a <code>launcher.sh</code> shell script, continuing the HAProxy example from above:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>HAPROXY_PID<span style=color:#f92672>=</span>-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># wait for 10 seconds, then send a USR1 signal to HAproxy</span>
</span></span><span style=display:flex><span>kill_haproxy<span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>  sleep <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  kill -USR1 $HAPROXY_PID
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># invoke kill_haproxy function when receives the TERM signal</span>
</span></span><span style=display:flex><span>trap kill_haproxy SIGTERM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Support the user hitting Ctrl-C, but only in interactive shells</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -t <span style=color:#ae81ff>1</span> <span style=color:#f92672>]]</span> ; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  trap <span style=color:#e6db74>&#39;kill -USR1 &#34;$HAPROXY_PID&#34;&#39;</span> SIGINT
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>haproxy -f config.cfg &amp; HAPROXY_PID<span style=color:#f92672>=</span>$!
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$HAPROXY_PID<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;haproxy: Haproxy failed to start&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;haproxy: haproxy started&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>And use this script in the <code>Dockerfile</code><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:3.5</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># install bash, tini and haproxy</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --no-cache bash tini haproxy<span style=color:#f92672>=</span>2.0.14-r0<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span> <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Run tini</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/usr/local/bin/tini&#34;</span>, <span style=color:#e6db74>&#34;—&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/launcher.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>This mitigation mechanism is based on the same underlying idea of waiting with the hope that, eventually, Kubernetes will not route new requests to the pod. The only difference is where this delay happens: in idea #1 it is in a Kubernetes pod lifecycle hook, in idea #2 it is in the application container. So really, it&rsquo;s just 2 different implementations of the same idea.</p><p>Therefore the same considerations about estimating the &ldquo;right&rdquo; delay time & grace period apply. There is no guarantee that the endpoint eviction will complete before waiting for some seconds. So you need to analyze the latencies in your infrastructure and your application to determine the &ldquo;right&rdquo; waiting values. Remember that endpoint eviction does not affect established connections, so either you need a long enough <code>spec.terminationGracePeriodSeconds</code> to terminate long-lived connections or you need to ensure that connections are short-lived.</p><h3 id=delay-app-shutdown---trade-offs>Delay app shutdown - Trade-Offs</h3><p>This approach modifies the application binary (the container image), so it can work on other orchestration systems (except for the <code>spec.terminationGracePeriodSeconds</code>). For us, that is a future, possible benefit, not an actual advantage that we utilize right now.</p><p>However it has drawbacks, firstly it forces us to forego graceful shutdown behavior that is built into application frameworks like <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-graceful-shutdown target=_blank rel="external noopener noreferrer nofollow">Spring Boot</a>.</p><p>Secondly, it suffers from low spatial cohesion - the delay timing is now encoded in the application source code, while the upper bound (<code>spec.terminationGracePeriodSeconds</code>) is in the Kubernetes object description. This makes the approach less readably (or understandable) because you have to look at 2 different files, possibly in 2 different code repositories, to understand the full picture. It also makes it harder to maintain, because you have to orchestrate application changes (delay timing) with configuration changes (<code>spec.terminationGracePeriodSeconds</code>).</p><h2 id=idea-3-_dynamically_-delay-app-shutdown>Idea #3: <em>Dynamically</em> delay app shutdown</h2><p>In internal discussions we outlined a 3rd approach that seems more robust than the others, but complicates the application:</p><ol><li>Run pod health checks every second</li><li>Don’t sleep on pre-stop hook</li><li>When the pod receives a <code>TERM</code> signal, start a stopwatch on the application layer.</li><li>Reset the stopwatch to zero every time the pod receives a request. It means we’re still getting traffic and we should be getting health check traffic as well.</li><li>When the stopwatch reaches <code>N</code> seconds, in other words <code>N</code> seconds without traffic, <strong>AND</strong> all connections are drained, we can kill the pod.</li></ol><p>This may or may not work, depending on when Kubernetes decides to stop sending health checks. We did not try this approach because it is a lot more complicated than a sleep and we can accept slower deployments. But, <em>in theory</em>, it is more reliable than ideas #1 and #2.</p><h2 id=conclusion>Conclusion</h2><p>In summary, we described the Kubernetes pod termination process, give recommendations on how to cleanly handle the <code>TERM</code> signal in different scenarios. Finally, we describe several techniques that allow us to avoid failures during Kubernetes pod eviction, e.g. during rolling deployments. None of the techniques are perfect, idea #1 & #2 require magic numbers which rely on the latencies in your infrastructure, your application shutdown and the long-(/short)-lived-ness of connections. But we have successfully used these mitigations in production services with 0% error rate during deployments<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>. Idea #3 is just that - an idea. We have not implemented it, so your mileage may vary.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>This limitation of iptables affects Kubernetes clusters using kube-proxy. Nowadays Kubernetes cluster operators have options other than kube-proxy & iptables: for example <a href=https://cilium.io/blog/2019/08/20/cilium-16#kubeproxy-removal target=_blank rel="external noopener noreferrer nofollow">cilium</a> or <a href=https://docs.projectcalico.org/about/about-ebpf target=_blank rel="external noopener noreferrer nofollow">calico</a> which use eBPF instead of iptables. We have not tested if eBPF CNI systems leave established connections untouched. But there is a <a href=https://github.com/cilium/cilium/issues/14844 target=_blank rel="external noopener noreferrer nofollow">bug in Cilium</a> that causes existing connections to also fail during pod termination. So existing connections are likely to remain a challenge.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Notably <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-graceful-shutdown target=_blank rel="external noopener noreferrer nofollow">Spring Boot</a> does not provide a straightforward hook to achieve that. Spring only exposes abstractions over the unix process signals like servlet context shutdown events.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>We don&rsquo;t use signal re-mapping through the init system in this example, instead we map signals explicitly in the shell script&rsquo;s trap. Moreover we use <code>tini</code> as init system, because installation as alpine package is a little neater than doing the manual download of <code>dumb-init</code>.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>This is all based on Kubernetes clusters using kube-proxy & iptables. Kubernetes is moving towards <a href=https://archive.fosdem.org/2020/schedule/event/replacing_iptables_with_ebpf/ target=_blank rel="external noopener noreferrer nofollow">CNI implementations that use eBPF instead of iptables</a>. But the behavior described here also applies to those eBPF based solutions (or at least seems to apply to it) and there may be more caveats that you have to keep in mind. For instance, Cilium seems to have a <a href=https://github.com/cilium/cilium/issues/14844 target=_blank rel="external noopener noreferrer nofollow">bug</a> that causes existing connections to also fail during pod termination, making graceful shutdown harder.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><section id=articleNext class="section nartrow"><h3 class=footer-next-heading>More articles from Rakuten Engineering Blog</h3><div class=footer-spacer></div><div class=next-articles-grid numberofarticles={numberOfArticles}><div class=post-row><a href=/post/altswiftui-travel/ class=article-link id=article-link-bigger><div><div class=image-container><img src=/post/altswiftui-travel/hero.png class=article-image></div><div><h2 class=article-title>Introducing AltSwiftUI in Rakuten Travel</h2><p class=article-excerpt>What is AltSwiftUI and how we introduced it in Rakuten Travel</p><div class=article-metadata>July 6, 2021 · 5 min read</div></div></div></a><a href=/post/rds-automating-designer-to-developer-handoff/ class=article-link><div><div class=image-container><img src=/post/rds-automating-designer-to-developer-handoff/images/rds_logo.png class=article-image></div><div><h2 class=article-title>RDS: Automating Code and Asset Generation From Figma</h2><p class=article-excerpt>Designer-to-developer handoff is an important part of the product development life cycle. It takes place when the design deliverables are ready to be provided to developers for implementation.</p><div class=article-metadata>November 16, 2021 · 4 min read</div></div></div></a></div></div></section></section><script src=/js/progressBar.js></script><div class=footer-gradient></div><div class="section narrow"><div class=footer-hr></div><div class=footer-container><div class=footer-text>&copy; 2022 Rakuten Group, Inc.<br><br><div class=license-icons><a rel=license href=https://creativecommons.org/licenses/by/4.0/ title="Creative Commons Attribution 4.0 International license"><i class=cc-icon-cc></i>
<i class=cc-icon-cc-by></i></a></div>Except where otherwise noted, content on this site is licensed under a <a rel="external noopener" href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International license</a>.</div><div class=footer-text><a href=https://github.com/rakutentech><svg class="social-icon-image" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path fillrule="evenodd" cliprule="evenodd" d="M7 0C3.1325.0.0 3.21173.0 7.17706.0 10.3529 2.00375 13.0353 4.78625 13.9863 5.13625 14.0491 5.2675 13.8338 5.2675 13.6454 5.2675 13.4749 5.25875 12.9097 5.25875 12.3087 3.5 12.6406 3.045 11.8691 2.905 11.4653 2.82625 11.259 2.485 10.622 2.1875 10.4516 1.9425 10.317 1.5925 9.98508 2.17875 9.97611 2.73 9.96714 3.12375 10.4964 3.255 10.7118c.63 1.0855 1.63625.7805 2.03875.5921C5.355 10.8374 5.53875 10.5234 5.74 10.3439 4.1825 10.1645 2.555 9.54549 2.555 6.80026c0-.7805.27125-1.42644.7175-1.92883C3.2025 4.692 2.9575 3.95635 3.3425 2.96951c0 0 .58625-.1884 1.925.73565.56-.16149 1.155-.24223 1.75-.24223s1.19.08074 1.75.24223c1.3388-.93302 1.925-.73565 1.925-.73565C11.0775 3.95635 10.8325 4.692 10.7625 4.87143 11.2087 5.37382 11.48 6.01079 11.48 6.80026c0 2.7542-1.63625 3.36424-3.19375 3.54364C8.54 10.5682 8.75875 10.9988 8.75875 11.6717 8.75875 12.6316 8.75 13.4032 8.75 13.6454 8.75 13.8338 8.88125 14.0581 9.23125 13.9863 11.9963 13.0353 14 10.3439 14 7.17706 14 3.21173 10.8675.0 7 0z" fill="#73737d"/></svg></a><a href=https://github.com/rakutentech>Rakuten Tech Github</a></div></div></div><script src=/js/extra.js></script></div><script src=/js/prism.js></script></body></html>